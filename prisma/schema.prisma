generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  MANAGER
  CLUB_OWNER
  ADMIN
}

model User {
  id             String              @id @default(cuid())
  email          String              @unique
  name           String
  emailVerified  Boolean
  isPublic       Boolean             @default(false)
  eventsSignedUp EventRegistration[]
  invitesSent    Invite[]
  ClubMembership ClubMembership[]

  image   String?
  Session Session[]
  Account Account[]

  // Other, optional user information
  bio      String?
  location String?
  website  String?
  phone    String?
  callsign String?
  gear     Json[] // { name: string, energy: string, fps: string }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user")
}

model Club {
  id String @id @default(cuid())

  name        String
  location    String?
  description String?
  dateFounded DateTime?

  isAllied  Boolean @default(false)
  isPrivate Boolean @default(false)

  logo         String  @default("https://f003.backblazeb2.com/file/airsoftba/club/default-club-image.png")
  logoBlurHash String?
  contactPhone String?
  contactEmail String?

  events  Event[]
  members ClubMembership[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClubMembership {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String
  club   Club   @relation(fields: [clubId], references: [id])
  clubId String
  role   Role   @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Event {
  id          String @id @default(cuid())
  name        String
  description String
  club        Club   @relation(fields: [clubId], references: [id])
  clubId      String

  coverImage String?

  dateStart DateTime
  dateEnd   DateTime?

  dateRegistrationsClose DateTime?
  dateRegistrationsOpen  DateTime?

  isPrivate        Boolean @default(false) // Private events are club-only events
  allowFreelancers Boolean @default(false) // Allow people not in a club to register

  location       String
  googleMapsLink String?

  costPerPerson Float @default(0)

  // Event-specific features
  hasBreakfast Boolean @default(false)
  hasLunch     Boolean @default(false)
  hasDinner    Boolean @default(false)
  hasSnacks    Boolean @default(false)
  hasDrinks    Boolean @default(false)
  hasPrizes    Boolean @default(false)

  // Event-specific rules
  rules Json[] // { name: string, description: string }

  // Event-specific gear requirements
  gearRequirements Json[] // { name: string, description: string }

  registrations EventRegistration[]
  invites       Invite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventRegistration {
  id       String  @id @default(cuid())
  event    Event   @relation(fields: [eventId], references: [id])
  eventId  String
  user     User?   @relation(fields: [userId], references: [id])
  userId   String? // Can be null for non-account users
  invite   Invite? @relation(fields: [inviteId], references: [id])
  inviteId String? // Event can be registered by invite link

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Invite Model (Manual Event Registration)
model Invite {
  id                String              @id @default(cuid())
  event             Event               @relation(fields: [eventId], references: [id])
  eventId           String
  email             String // Email of the person receiving the invite
  secureLink        String              @unique // Generated unique link for registration
  inviter           User                @relation(fields: [inviterId], references: [id])
  inviterId         String
  EventRegistration EventRegistration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Auth stuff below

model Session {
  id        String   @id
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id           String    @id
  accountId    String
  providerId   String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String?
  refreshToken String?
  idToken      String?
  expiresAt    DateTime?
  password     String?

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime

  @@map("verification")
}

// model Club {
//   id         String       @id @default(uuid())
//   name       String
//   createdBy  String
//   createdAt  DateTime     @default(now())
//   updatedAt  DateTime     @updatedAt
//   createdByUser User      @relation("CreatedClubs", fields: [createdBy], references: [id])
//   members    ClubMember[]
//   events     Event[]
//
//   @@index([createdBy])
// }
//
// model ClubMember {
//   id        String   @id @default(uuid())
//   clubId    String
//   userId    String
//   joinedAt  DateTime @default(now())
//
//   club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
//   user      User     @relation(fields: [userId], references: [id])
//
//   @@unique([userId]) // Ensures a user can only be in one club
//   @@unique([clubId, userId])
//
//   @@index([clubId])
//   @@index([userId])
// }
//
// model Team {
//   id         String       @id @default(uuid())
//   name       String
//   createdBy  String
//   createdAt  DateTime     @default(now())
//   updatedAt  DateTime     @updatedAt
//   createdByUser User      @relation("CreatedTeams", fields: [createdBy], references: [id])
//   members    TeamMember[]
//
//   @@index([createdBy])
// }
//
// model TeamMember {
//   id        String   @id @default(uuid())
//   teamId    String
//   userId    String
//   role      TeamRole @default(MEMBER)
//   joinedAt  DateTime @default(now())
//
//   team      Team     @relation(fields: [teamId], references: [id])
//   user      User     @relation(fields: [userId], references: [id])
//
//   @@unique([teamId, userId])
//   @@index([teamId])
//   @@index([userId])
// }
//
// enum TeamRole {
//   LEADER
//   MEMBER
// }
//
// model Event {
//   id            String    @id @default(uuid())
//   title         String
//   description   String?
//   createdBy     String
//   clubId        String
//   createdAt     DateTime  @default(now())
//   updatedAt     DateTime  @updatedAt
//   startDate     DateTime
//   endDate       DateTime?
//   durationInHours Float?
//   freeFood      Boolean   @default(false)
//   offroadAccess Boolean   @default(false)
//   locationLat   Float
//   locationLng   Float
//   createdByUser User      @relation("CreatedEvents", fields: [createdBy], references: [id])
//   club          Club      @relation(fields: [clubId], references: [id], onDelete: Cascade)
//   images        EventImage[]
//   managers      Manager[]
//   rules         EventRule[]
//   applications  EventApplication[]
//
//   @@index([startDate])
//   @@index([createdBy])
//   @@index([clubId])
// }
//
// model EventImage {
//   id        String @id @default(uuid())
//   eventId   String
//   imageUrl  String
//
//   event     Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
// }
//
// model EventRule {
//   id        String  @id @default(uuid())
//   eventId   String
//   ruleText  String
//   createdAt DateTime @default(now())
//
//   event     Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
// }
//
// model EventApplication {
// id             String          @id @default(uuid())
// eventId        String
// applicantType  ApplicantType    @default(USER)
// userId         String?
// teamId         String?
// managerId      String?
// status         ApplicationStatus @default(PENDING)
// appliedAt      DateTime        @default(now())
//
// event          Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
// user           User?           @relation("UserApplications", fields: [userId], references: [id])
// team           Team?           @relation(fields: [teamId], references: [id])
// manager        User?           @relation(fields: [managerId], references: [id])
// participants   EventApplicationParticipant[]
//
// @@check(
//   (applicantType = "USER" AND userId IS NOT NULL AND teamId IS NULL) OR
//   (applicantType = "TEAM" AND teamId IS NOT NULL AND userId IS NULL)
// )
//
// @@index([eventId])
// @@index([userId])
// @@index([teamId])
// }
//
// model EventApplicationParticipant {
//   id                   String  @id @default(uuid())
//   eventApplicationId    String
//   participantName       String
//   participantEmail      String?
//
//   eventApplication      EventApplication @relation(fields: [eventApplicationId], references: [id], onDelete: Cascade)
//
//   @@index([eventApplicationId])
// }
//
// model Manager {
//   id                 String          @id @default(uuid())
//   managedEntityId    String
//   managedEntityType  ManagedEntityType
//   userId             String
//   assignedAt         DateTime         @default(now())
//
//   user               User             @relation(fields: [userId], references: [id])
//
//   @@unique([managedEntityId, managedEntityType, userId])
//
//   @@index([managedEntityId, managedEntityType])
//   @@index([userId])
// }
//
// enum ApplicantType {
//   USER
//   TEAM
// }
//
// enum ApplicationStatus {
//   PENDING
//   APPROVED
//   REJECTED
// }
//
// enum ManagedEntityType {
//   CLUB
//   EVENT
// }
